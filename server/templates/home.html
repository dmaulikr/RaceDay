<!DOCTYPE html>
<!--[if lt IE 7]>      <html class='no-js lt-ie9 lt-ie8 lt-ie7'> <![endif]-->
<!--[if IE 7]>         <html class='no-js lt-ie9 lt-ie8'> <![endif]-->
<!--[if IE 8]>         <html class='no-js lt-ie9'> <![endif]-->
<!--[if gt IE 8]><!--> <html class='no-js'> <!--<![endif]-->
    <head>
        <meta charset='utf-8'>
        <meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
        <title>Race Day</title>

       <link rel="stylesheet" href="http://js.arcgis.com/3.12/esri/css/esri.css">
       <link rel="stylesheet" href="http://js.arcgis.com/3.12/dijit/themes/claro/claro.css">
       
       <script src="http://js.arcgis.com/3.12/"></script>
       <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

       <style type="text/css">
          body {
             width: 100%;
             height: 100%;

             font-family: HelveticaNeue-Light;
          }

          h2 {
             color: #576E91;
          }
           
          #map {
             position: absolute;
             left:     0;
             right:    30%;
             bottom:   0;
             top:      50px;
          }
          
          .esriSignInDialog {
              background-color: white;
              padding: 10px;
              border-radius: 10px;
          }

          #list {
              position: absolute;
              left: 70%;
              right: 0;
              top: 50px;
              bottom: 0;
              background-color: #CC6600;
          }

          .list-item {
              border: 1px solid #5780A6;
              cursor: pointer;
              padding: 5px;
          }

          .list-title {
              font-size: 20px;
          }

          .list-detail {
              font-size: 14px;
          }

          .list-number {
              float: left;
              font-size: 20px;
              margin-right: 10px;
          }

          #list h2 {
              margin-left: 10px;
          }
       </style>

        <script type="text/javascript">
         require(["esri/map", "esri/layers/FeatureLayer","dojo/domReady!", "esri/geometry/Point", 
                  "esri/symbols/SimpleMarkerSymbol", "esri/graphic", "esri/layers/GraphicsLayer", 
                  "esri/SpatialReference", "esri/renderers/SimpleRenderer", "esri/Color", "esri/InfoTemplate"], 
                 function(Map, FeatureLayer) { 
                     var infoTemplate = new esri.InfoTemplate();
                     infoTemplate.setTitle("${name}");
                     infoTemplate.setContent('<b>Distance: </b> ${distance}<br>' +
                                             '<b>Latitude: </b> ${latitude}<br>' +
                                             '<b>Longitude: </b> ${longitude}<br>');

                     
                     map = new Map("map", {
                         center: [-118, 34.5],
                         zoom: 8,
                         basemap: "gray"
                     });
                     
                     map.on("load", initOperationalLayer);

                     graphicsLayer = new esri.layers.GraphicsLayer({
                         outFields: ['*'],
                         infoTemplate: infoTemplate
                     });
                     // graphicsLayer.setInfoTemplate(infoTemplate);
                     map.addLayer(graphicsLayer);
                     
                     function initOperationalLayer() {
                         featureLayer = new FeatureLayer('http://services1.arcgis.com/W4Noi4OZras42xbd/arcgis/rest/services/Races/FeatureServer/0', {
                             mode: FeatureLayer.MODE_SNAPSHOT,
                             outFields: ["*"]
                         });
                         
                         map.addLayer(featureLayer);

                         setTimeout(function() {
                             $('.dijitReset.dijitInputInner')[0].value = 'scottsirowy';
                             $('.dijitReset.dijitInputInner')[1].value = 'Crowded2000';
                             $($('.dijitReset.dijitInline.dijitButtonNode')[0]).click();

                             setTimeout(function() {
                                 renderRacesList();
                             }, 1000);
                         }, 1000);
                     }
                 });

         function renderRacesList() {
             var races = window.featureLayer.graphics.map(function(graphic) {
                 var _graphic = graphic;
                 return {
                     title: graphic.attributes.title,
                     detailLabel: 'Start time',
                     detail: graphic.attributes.start_time,
                     id: graphic.attributes.OBJECTID,
                     callback: function() {
                         // Zoom the map to the race.
                         var extent = new esri.geometry.Extent(_graphic.geometry._extent);
                         extent = extent.expand(1.4);
                         map.setExtent(extent);

                         // Pull the list of users for that race.
                         $.get('/race/' + _graphic.attributes.OBJECTID, {}, function(data) {
                             // Sort each user's data according to distance.
                             data.users.forEach(function(user) {
                                 user.data.sort(function(a, b) {
                                     return b.distance - a.distance;
                                 });
                             });
                             
                             // Render each user's location on the map.
                             data.users.forEach(function(user) {
                                 var userPoint = new esri.geometry.Point(user.data[0].location.longitude, 
                                                                         user.data[0].location.latitude, 
                                                                         new esri.SpatialReference({ wkid: 3857 }))
                                 symbol = new esri.symbol.SimpleMarkerSymbol();
                                 
                                 symbol.setColor(new esri.Color('#FF0000'));
                                 
                                 user.graphic = new esri.Graphic(userPoint, symbol);
                                 user.graphic.attr('name', 'THIS IS A TEST');
                                 user.graphic.setAttributes({
                                     name: user.user.name,
                                     email: user.user.email,
                                     distance: user.data[0].distance,
                                     latitude: user.data[0].location.latitude,
                                     longitude: user.data[0].location.longitude
                                 });

                                 console.log(user.graphic);

                                 // map.graphics.add(user.graphic);
                                 graphicsLayer.add(user.graphic);
                             });

                             // Sort users according to distance.
                             data.users.sort(function(a, b) {
                                 return b.data[0].distance - a.data[0].distance;
                             });

                             // Render each user in the user list.
                             renderUsersList(data.users);
                         });
                     }
                 };
             });

             renderList(races, 'Races', false);
         }

         function renderUsersList(users) {
             var userElements = users.map(function(user, index) {
                 var _user = user;
                 user = user.user;
                 return {
                     title: user.name,
                     detailLabel: 'Email',
                     detail: user.email,
                     id: index,
                     callback: function() {
                         map.graphics.remove(_user.graphic);
                     }
                 }
             });
             
             renderList(userElements, 'Users', true);
         }

         /*
           Each element is in this form:

           {
             title: '',
             detail: '',
             id: 123,
             callback: function // called when element is clicked
           }
         */
         function renderList(elements, header, numbered) {
             // Render a list of all races.
             var listHtml = '';
             elements.forEach(function(element, index) {
                 listHtml += '<div class="list-item" id="element' + element.id + '">'

                 if (numbered) {
                     listHtml += '<div class="list-number">' + (index + 1) + '</div>';
                 }
                 
                 listHtml += '<div class="list-title">' + element.title + '</div>'
                 listHtml += '<div class="list-detail">' + element.detailLabel + ': ' + element.detail + '</div>'
                 
                 listHtml += '</div>'
             });

             $('#list-elements').html(listHtml);
             $('#list > h2').html(header);

             // Add click events to each race.
             elements.forEach(function(element) {
                 var _element = element;
                 $('#element' + element.id).click(function() {
                     _element.callback();
                 });
             });
         }
        </script>

    </head>
    <body>
       <h2>Race day app</h2>
       <div id="map"></div>
       <div id="list">
         <h2>Races</h2>
         <div id="list-elements"></div>
       </div>
    </body>
</html>
